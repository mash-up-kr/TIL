# 무중단 배포

## Travis CI 배포 자동화 환경의 문제점

배포하는 동안 애플리케이션이 종료된다는 문제가 있다. 긴 시간은 아니지만, 새로운 Jar 애플리케이션이 실행되기 전까지 기존 Jar 애플리케이션을 종료시키기 때문에 서비스가 잠깐 중단된다. 반면, 24시간 서비스의 경우 배포하는 동안 서비스가 중단되지 않는다.

## 무중단 배포 소개

무중단 배포는 서비스를 중지하지 않고 배포할 수 있는 방법이다. 무중단 배포 방식에는 몇 가지 방식이 있다.

- AWS에서 블루 그린(Blue-Green) 무중단 배포
- 도커를 이용한 웹서비스 무중단 배포
- L4 스위치를 이용한 무중단 배포
  - 고가의 장비이다보니 대형 서비스 기업 외에는 쓸 일이 거의 앖다.

엔진엑스를 이용한 무중단 배포 방법이 있다.

**엔진엑스(Nginx)**는 웹 서버, 리버스 프록시, 캐싱, 로드 밸런싱, 미디어 스트리밍 등을 위한 오픈소스 소프트웨어다. 고성능 웹서버이기 때문에 대부분 서비스들이 현재는 엔진엑스를 사용하고 있다. 게다가 가장 저렴하고 쉽기 때문에 많이 채택한다.

엔진엑스의 기능 중 리버스 프록시 기능이 있다. 리버스 프록시는 엔진엑스가 외부의 요청을 받아 백엔드 서버로 요청을 전달하는 행위를 이야기한다. 리버스 프록시 서버(엔진엑스)는 요청을 전달하고, 실제 요청에 대한 처리는 뒷단의 웹 애플리케이션 서버들이 처리한다.

꼭 AWS와 같은 범용 클라우드 인프라가 구축되지 않아도 사용할 수 있다. 개인 서버 혹은 사내 서버에도 동일한 방식으로 구축할 수 있으므로 매우 유용하다. 하나의 EC2 혹은 리눅스 서버에 엔진엑스 1대와 스트링 부트 Jar를 2대를 사용하면 된다.

- 엔진엑스는 80(http), 443(https) 포트를 할당한다.
- 스프링 부트1은 8081 포트로 실행한다.
- 스프링 부트2은 8082 포트로 실행한다.

엔진엑스 무중단 배포 방법 1은 다음과 같다.

- 사용자는 서비스 주소로 접속한다. (80 혹은 443 포트)
- 엔진엑스는 사용자의 요청을 받아 현재 연결된 스프링 부트1 8081 포트로 요청을 전달한다.
- 스프링 부트2는 엔진엑스와 연결된 상태가 아니니 요청받지 못한다.

1.1 버전으로 신규 배포가 필요하면, 엔진엑스와 연결되지 않은 스프링 부트2(8082 포트)로 배포한다.

- 배포하는 동안 서비스는 중단되지 않는다.
  - 엔진엑스는 스프링 부트1을 바라보기 때문
- 배포가 끝나고 정상적으로 스프링 부트2가 구동 중인지 확인한다.
- 스프링 부트2가 정상 구동 중이면 nginx reload 명령어를 통해 8081 대신에 8082를 바라보도록 한다.
- nginx reload는 0.1초 이내에 완료된다.

1.2 버전 배포가 필요하면 이번에는 스프링 부트 1로 배포한다.

- 현재는 엔진엑스와 연결된 것이 스프링 부트2
- 스프링 부트1의 배포가 끝나면 엔진엑스가 스프링 부트1을 바라보도록 변경하고 nginx reload를 실행한다.
- 이후 요청부터는 엔진엑스가 스프링 부트 1로 요청을 전달한다.

## 참고 도서

스프링 부트와 혼자 구현하는 웹 서비스